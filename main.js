/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var _=Object.defineProperty;var W=Object.getOwnPropertyDescriptor;var R=Object.getOwnPropertyNames;var j=Object.prototype.hasOwnProperty;var F=(n,e)=>{for(var t in e)_(n,t,{get:e[t],enumerable:!0})},D=(n,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let a of R(e))!j.call(n,a)&&a!==t&&_(n,a,{get:()=>e[a],enumerable:!(r=W(e,a))||r.enumerable});return n};var $=n=>D(_({},"__esModule",{value:!0}),n);var J={};F(J,{default:()=>E});module.exports=$(J);var m=require("obsidian");var S=require("obsidian");var l=navigator.language||"en",p={iKnow:{en:"I know",ru:"\u0417\u043D\u0430\u044E",es:"Yo s\xE9",fr:"Je sais"},repeat:{en:"Repeat",ru:"\u041F\u043E\u0432\u0442\u043E\u0440\u0438\u0442\u044C",es:"Repetir",fr:"R\xE9p\xE9ter"},total:{en:"Total cards",ru:"\u0412\u0441\u0435\u0433\u043E \u043A\u0430\u0440\u0442\u043E\u0447\u0435\u043A",es:"Total de tarjetas",fr:"Total de cartes"},cards:{en:"cards",ru:"\u043A\u0430\u0440\u0442\u043E\u0447\u0435\u043A",es:"tarjetas",fr:"cartes"},parseError:{en:"Parse error",ru:"\u041E\u0448\u0438\u0431\u043A\u0430 \u043E\u0431\u0440\u0430\u0431\u043E\u0442\u043A\u0438",es:"Parse error",fr:"Erreur de parsing"},reload:{en:"Sync with leaf content",fr:"Synchroniser avec le contenu de page",ru:"\u0421\u0438\u043D\u0445\u0440\u043E\u043D\u0438\u0437\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u0441 \u0441\u043E\u0434\u0435\u0440\u0436\u0438\u043C\u044B\u043C \u043B\u0438\u0441\u0442\u0430",es:"Sincronizar con el contenido de hoja"},empty:{en:"No card",ru:"\u041D\u0435\u0442 \u043A\u0430\u0440\u0442\u043E\u0447\u043A\u0438",es:"No hay tarjeta",fr:"Pas de carte"},noContext:{en:"Open and close the codeBock to update",ru:"\u041E\u0442\u043A\u0440\u044B\u0442\u044C \u0438 \u0437\u0430\u043A\u0440\u044B\u0442\u044C \u043A\u043E\u0434\u043E\u0432\u044B\u0439 \u0431\u043B\u043E\u043A \u0434\u043B\u044F \u043E\u0431\u043D\u043E\u0432\u043B\u0435\u043D\u0438\u044F",es:"Abrir y cerrar el c\xF3digo de bloque para actualizar",fr:"Ouvrir et fermer le bloc de code pour mettre \xE0 jour"},nothingToClean:{en:"Nothing to clean",ru:"\u041D\u0435\u0447\u0435\u0433\u043E \u043E\u0447\u0438\u0441\u0442\u0438\u0442\u044C",es:"Nada que limpiar",fr:"Rien \xE0 nettoyer"},statsCleaned:{en:"Stats cleaned",ru:"\u0421\u0442\u0430\u0442\u0438\u0441\u0442\u0438\u043A\u0430 \u043E\u0447\u0438\u0449\u0435\u043D\u0430",es:"Estad\xEDsticas limpiadas",fr:"Statistiques nettoye\xE9es"}};async function h(n,e){let t=e.getSectionInfo(n);if(!t)return"";let r=t.text.split(`
`);return r=r.filter(o=>!/^#{1,6}\s+/.test(o)),r.length?N(r,t.lineEnd):""}function N(n,e){let t=n.slice(e),r=t.findIndex(a=>a.trim().startsWith("```voca-card")||a.trim().startsWith("```voca-table"));return r!==-1&&(t=t.slice(0,r)),t.join(`
`).trim()}function M(n,e){let i=n.map(u=>{let[v,I]=e.getStats(u),k=(Math.log(I+1)+1)/(v+1);return k=Math.min(k*(1+Math.random()*.2),5),{card:u,weight:k}});n.length>100&&i.sort((u,v)=>v.weight-u.weight);let c=i.reduce((u,v)=>u+v.weight,0),s=Math.random()*c,d=0;for(let u of i)if(d+=u.weight,s<d)return u.card;return i[0].card}function f(n){n.createEl("div",{cls:"voca-card"}).createEl("div",{cls:"voca-card-empty",text:p.empty[l]})}function b(n,e,t){e.createEl("button",{cls:"voca-card_empty-reload",text:"\u21BA"}).addEventListener("click",async()=>{await n.parseCodeBlock(e,t)})}function P(){return Date.now().toString()}async function L(){let n=this.app.vault.getMarkdownFiles(),e=/^```(voca-card|voca-table)\s*(.*?)\s*$/gm,t=new Set;for(let a of n){let i=(await this.app.vault.cachedRead(a)).matchAll(e);for(let c of i){let s=c[2].trim();s&&t.add(s)}}let r=Object.keys(this.stats).filter(a=>!t.has(a));if(!r.length){new S.Notice(p.nothingToClean[l]);return}for(let a of r)delete this.stats[a];new S.Notice(p.statsCleaned[l]),await this.saveData(this.stats)}var C=class{constructor(e,t,r,a,o){this.plugin=e;this.app=t;this.el=r;this.ctx=a;this.cardList=o;this.id=""}async initialize(){await this.resolveId()}async resolveId(){var o;let e=this.ctx.getSectionInfo(this.el);if(!e)return"";let t=e.text.split(`
`),r=(o=t[e.lineStart])!=null?o:"",a=/^`{3,}\S+\s+(.*)$/.exec(r);a?this.id=a[1].trim():this.id=await this.createAndSaveNewId(t,e)}async createAndSaveNewId(e,t){let r=P(),a=this.app.vault.getFileByPath(this.ctx.sourcePath);return a?(await this.app.vault.process(a,o=>{let i=e.slice();i[t.lineStart]=i[t.lineStart].trim()+` id:${r}`;let c=i.join(`
`);return o.replace(t.text,c)}),r):""}getStats(e){let t=this.plugin.stats[this.id];if(!t)return[e.rightCount,e.wrongCount];let r=t[e.derivative];return r?[r.r,r.w]:[e.rightCount,e.wrongCount]}async cleanupSavedStats(){let e=this.plugin.stats;if(!e[this.id])return;let t=new Set(this.cardList.cards.map(a=>a.derivative)),r={};for(let[a,o]of Object.entries(e[this.id]))t.has(a)&&(r[a]=o);e[this.id]=r,await this.plugin.saveStats()}async rightAnswer(e){await this.updateAnswer(e,!0)}async wrongAnswer(e){await this.updateAnswer(e,!1)}async updateAnswer(e,t){this.plugin.stats[this.id]||(this.plugin.stats[this.id]={}),t?(e.incrementRight(),e.setWrong(0)):(e.incrementWrong(),e.setRight(0)),this.plugin.stats[this.id][e.derivative]={r:e.rightCount,w:e.wrongCount},await this.plugin.saveStats()}};var w=class{constructor(e,t,r){this.derivative=e;this.transcription=t;this.explanation=r;this._rightCount=0;this._wrongCount=0;if(!this.isValid())throw new Error("Invalid card: derivative must be non-empty and at least one of transcription or explanation must be non-empty")}get rightCount(){return this._rightCount}get wrongCount(){return this._wrongCount}isValid(){return this.derivative!==""&&(this.transcription!==""||this.explanation!=="")}setRight(e){this._rightCount=Math.max(0,Math.min(e,5))}setWrong(e){this._wrongCount=Math.max(0,Math.min(e,5))}incrementRight(){this._rightCount=Math.min(this._rightCount+1,5)}incrementWrong(){this._wrongCount=Math.min(this._wrongCount+1,5)}reset(){this._rightCount=0,this._wrongCount=0}};var T;T=Symbol.iterator;var g=class{constructor(e,t){this.plugin=e;this.src=t;this.cards=[];this.currentCard=void 0;this[T]=()=>{let e=0;return{next:()=>e<this.length?{value:this.cards[e++],done:!1}:{done:!0}}};t&&this.parseSource(t)}get length(){return this.cards.length}push(e){this.cards.push(e)}updateSource(e){this.cards=[],this.parseSource(e)}parseSource(e){let t=e.split(`
`);for(let r of t){let a=this.parseLine(r);a&&this.push(a)}}parseLine(e){let t=e.trim().replace(/^\s*[-+*]\s*/,"");if(!t)return null;let[r,...a]=t.split(":"),o=r.trim().replace(/^\*+|\*+$/g,""),i=a.join(":").trim(),{transcription:c,explanation:s}=this.parseTranscriptionAndExplanation(i);if(s)try{return new w(o,c,s.replace(/^\*+|\*+$/g,""))}catch(d){console.warn(`Skipping invalid card: ${o}. Error: ${d.message}`)}return null}parseTranscriptionAndExplanation(e){let t="",r="",a=e.match(/^\[(.+?)\]\s*(.*)$/);return a?(t=a[1].trim(),r=a[2].trim()):r=e,{transcription:t,explanation:r}}};var B=require("obsidian");function K(n,e){let t=n.createEl("tr"),r=t.createEl("td",{cls:"voca-table_derivative"});r.createEl("span",{cls:"voca-table_derivative-text",text:e.derivative}),e.transcription&&O(r,e.transcription),t.createEl("td",{cls:"voca-table_explanation"}).createEl("span",{text:e.explanation})}function O(n,e){let t=n.createEl("span",{cls:"voca-table_derivative-transcription"});t.createEl("span",{cls:"voca-table_derivative-transcription-delimiter",text:"/"}),t.createEl("span",{cls:"voca-table_derivative-transcription-text",text:e}),t.createEl("span",{cls:"voca-table_derivative-transcription-delimiter",text:"/"})}function x(n,e,t,r){t.innerHTML="";let a=t.createEl("table",{cls:"voca-table"}),o=a.createEl("tbody");for(let i of e)i&&K(o,i);y(n,a,e,r,"table")}function V(n,e,t,r){let a=e.getStats(t),o=n.createEl("span",{cls:"voca-card_stat"});r.length&&n.createEl("span",{cls:"voca-card_stat-total",title:p.total[l],text:`${r.length.toString()} ${p.cards[l]}`}),o.createEl("span",{cls:"voca-card_stat-wrong",text:a[1].toString()}),o.createEl("span",{cls:"voca-card_stat-delimiter",text:"/"}),o.createEl("span",{cls:"voca-card_stat-right",text:a[0].toString()})}function y(n,e,t,r,a="table",o){let i=a==="card"?"voca-card_button-reload":"voca-table_button-reload";e.createEl("button",{cls:i,title:p.reload[l],text:" \u21BA"}).addEventListener("click",async()=>{if(!r)return;let s=await h(e,r);if(!s){let d=e.parentElement;if(!d)return;e.detach(),f(d),b(n,d,this.ctx);return}if(a==="card"){t.updateSource(s);let d=e.parentElement;if(!d)return;e.detach(),await n.renderCard(o,t,d,r,s)}else t.updateSource(s),x(n,t,e,r)})}function A(n,e){n.createEl("span",{cls:"voca-card_derivative",text:e.derivative}),n.createEl("span",{cls:"voca-card_ts",text:e.transcription||" "});let t=n.createEl("span",{cls:"voca-card_explanation-blurred",text:e.explanation});t.addEventListener("click",()=>{t.classList.remove("voca-card_explanation-blurred"),t.classList.add("voca-card_explanation")})}function H(n,e,t,r,a,o,i,c){let s=e.createEl("div",{cls:"voca-card_buttons"});s.createEl("button",{cls:"voca-card_button-danger",text:p.repeat[l]}).addEventListener("click",async()=>{await z(n,a,r,t,o,i,!1,c)}),s.createEl("button",{cls:"voca-card_button-success",text:p.iKnow[l]}).addEventListener("click",async()=>{await z(n,a,r,t,o,i,!0,c)})}function q(n){return n.cards.filter(t=>t!==n.currentCard).length?!1:(new B.Notice("Only one card",3e3),!0)}async function z(n,e,t,r,a,o,i,c){q(e)||(i?t.rightAnswer(r):await t.wrongAnswer(r),n.renderCard(t,e,a,o,c))}var E=class extends m.Plugin{constructor(){super(...arguments);this.viewedIds=[]}async onload(){this.registerMarkdownCodeBlockProcessor("voca-table",async(t,r,a)=>{await this.renderTable(t,r,a),r.addEventListener("contextmenu",this.handleContextMenu.bind(this))}),this.registerMarkdownCodeBlockProcessor("voca-card",async(t,r,a)=>{await this.parseCodeBlock(r,a),r.addEventListener("contextmenu",this.handleContextMenu.bind(this))})}handleContextMenu(t){t.preventDefault();let r=new m.Menu;r.addItem(a=>a.setTitle("Clean up old stats (deleted codeblocks)").setIcon("trash").onClick(async()=>await L.bind(this)())),r.showAtMouseEvent(t)}async loadStats(){this.stats=await this.loadData()||{}}async saveStats(){await this.saveData(this.stats)}async parseCodeBlock(t,r){if(await this.loadStats(),!r){new m.Notice(p.noContext[l]);return}let a=await h(t,r);if(!a){this.createEmptyCard(t,r);return}let o=new g(this,a),i=new C(this,this.app,t,r,o);await i.initialize(),await this.renderCard(i,o,t,r,a)}createEmptyCard(t,r){f(t),b(this,t,r)}async renderCard(t,r,a,o,i){a.innerHTML="";let c=this.selectCard(r,t);c&&(r.currentCard=c,await this.renderSingleCard(c,r,t,a,o,i))}selectCard(t,r){let a=t.cards.filter(o=>o!==t.currentCard);return a.length?M(a,r):void 0}async renderSingleCard(t,r,a,o,i,c){let s=o.createDiv("voca-card");await a.cleanupSavedStats(),V(s,a,t,r),y(this,s,r,i,"card",a),A(s,t),H(this,s,t,a,r,o,i,c)}async renderTable(t,r,a){if(t=await h(r,a)||"",!t)this.createEmptyCard(r,a);else{let o=new g(this,t);x(this,o,r,a)}}};
